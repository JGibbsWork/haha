morning_shock_loop:
  alias: Morning Shock Loop
  mode: restart
  sequence:
  - target:
      entity_id: counter.morning_shock_counter
    action: counter.reset
    data: {}
  - repeat:
      while:
      - condition: state
        entity_id: device_tracker.jamess_iphone
        state: home
      - condition: numeric_state
        entity_id: counter.morning_shock_counter
        below: 8
      - condition: and
        conditions:
        - condition: state
          entity_id: input_boolean.left_home_today
          state: 'off'
      sequence:
      - variables:
          shock_intensity: '{% set level = states(''counter.morning_shock_counter'')
            | int %} {% set base = 50 %} {% set increment = 10 %} {{ [base + (level
            * increment), 80] | min }}

            '
      - data:
          shock_value: '{{ shock_intensity }}'
        action: rest_command.pavlok_dynamic_shock
      - target:
          entity_id: counter.morning_shock_counter
        action: counter.increment
        data: {}
      - action: counter.increment
        metadata: {}
        data: {}
        target:
          entity_id: counter.shocks_sent
      - action: rest_command.habitica_lounge_negative
        metadata: {}
        data: {}
      - delay:
          minutes: 5
tv_blind_up:
  alias: projector toggle
  mode: restart
  sequence:
  - condition: template
    value_template: '{{ states(''remote.broadlink'') not in [''unavailable'',''unknown'']
      }}

      '
  - action: remote.send_command
    target:
      entity_id: remote.broadlink
    data:
      device: wall
      command: power
      num_repeats: 1
      delay_secs: 0.4
      hold_secs: 3
  - action: input_boolean.toggle
    target:
      entity_id: input_boolean.projector_on
projectorprofileflow:
  sequence:
  - if:
    - condition: time
      after: 05:00:00
      before: 09:00:00
      weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
    then:
    - action: rest_command.projector_profile_morning
      metadata: {}
      data: {}
    else:
    - if:
      - condition: time
        after: 09:00:00
        before: '17:00:00'
      then:
      - action: rest_command.projector_profile_work
        metadata: {}
        data: {}
      else:
      - action: rest_command.projector_profile_default
        metadata: {}
        data: {}
  alias: ProjectorProfileFlow
  description: ''
pihole_block_day:
  sequence:
  - service: shell_command.pihole_login
  - delay: 00:00:02
  - service: rest_command.pihole_enable_dayblock
pihole_unblock_day:
  sequence:
  - service: shell_command.pihole_login
  - delay: 00:00:02
  - service: rest_command.pihole_disable_dayblock
couch_shock_loop:
  alias: Couch Shock Loop
  mode: restart
  sequence:
  - repeat:
      while:
      - condition: state
        entity_id: input_boolean.couch_occupied
        state: 'on'
      sequence:
      - action: rest_command.pavlok_couch
        data: {}
      - delay:
          minutes: 1
  description: ''
bed_shock_loop:
  alias: Bed Shock Loop
  mode: restart
  sequence:
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.presence_bed
        state: 'on'
      sequence:
      - action: rest_command.pavlok_bed
      - delay:
          minutes: 1
open_blinds:
  sequence:
  - device_id: 0927c6f398ab48e79514fcb132499e18
    domain: cover
    entity_id: e80f7de78e5ca17dfff1cc0d725e414c
    type: open
  - device_id: de64dceae59b28e117982717191dca37
    domain: cover
    entity_id: 8ea437962e557ba07542e9dff0456961
    type: open
  - device_id: 04eeedd90ececa5fad6b261555f8024a
    domain: cover
    entity_id: 0e390d6c5aca6476db51faf919eeabd4
    type: open
  - device_id: efa9b26832ac7e39a4d8cf528c21a026
    domain: cover
    entity_id: 198183b956106fc88984b9a33b0f2f0d
    type: open
  - device_id: 606436b1271fc3248ffac1f14b4a44b2
    domain: cover
    entity_id: 487e5a41ff5d95b0a916dd643279582c
    type: open
  alias: Open Blinds
  description: ''
close_blinds:
  sequence:
  - device_id: 0927c6f398ab48e79514fcb132499e18
    domain: cover
    entity_id: e80f7de78e5ca17dfff1cc0d725e414c
    type: close
  - device_id: de64dceae59b28e117982717191dca37
    domain: cover
    entity_id: 8ea437962e557ba07542e9dff0456961
    type: close
  - device_id: 04eeedd90ececa5fad6b261555f8024a
    domain: cover
    entity_id: 0e390d6c5aca6476db51faf919eeabd4
    type: close
  - device_id: efa9b26832ac7e39a4d8cf528c21a026
    domain: cover
    entity_id: 198183b956106fc88984b9a33b0f2f0d
    type: close
  - device_id: 606436b1271fc3248ffac1f14b4a44b2
    domain: cover
    entity_id: 487e5a41ff5d95b0a916dd643279582c
    type: close
  alias: Close Blinds
  description: ''
close_shades:
  sequence:
  - device_id: 5ba9ca5cc8c5019451d449254917efb9
    domain: cover
    entity_id: 46839409154dbeec24f2b919611a1716
    type: close
  - device_id: 411b53495742315afd9d68033abcb3d6
    domain: cover
    entity_id: 0a1ea51cc0f0d26611c316dd6fa55fba
    type: close
  - device_id: 78f9c69e89c0e075e678498e3ca4851e
    domain: cover
    entity_id: 40450dd49b1635cea177fe0ed036bcb7
    type: close
  - device_id: 7652fde55b2ae7ce88d139badeebc6a1
    domain: cover
    entity_id: 9c4eca97ced13f76b46caed85bb4ac52
    type: close
  alias: Close Shades
  description: ''
open_shades:
  sequence:
  - device_id: 5ba9ca5cc8c5019451d449254917efb9
    domain: cover
    entity_id: 46839409154dbeec24f2b919611a1716
    type: open
  - device_id: 411b53495742315afd9d68033abcb3d6
    domain: cover
    entity_id: 0a1ea51cc0f0d26611c316dd6fa55fba
    type: open
  - device_id: 78f9c69e89c0e075e678498e3ca4851e
    domain: cover
    entity_id: 40450dd49b1635cea177fe0ed036bcb7
    type: open
  - device_id: 7652fde55b2ae7ce88d139badeebc6a1
    domain: cover
    entity_id: 9c4eca97ced13f76b46caed85bb4ac52
    type: open
  alias: Open Shades
  description: ''
good_morning_briefing:
  alias: Good Morning Briefing (LLM)
  mode: restart
  fields:
    speak:
      description: true = speak to media player, false = notification only
      example: true
  variables:
    media_player: media_player.living_room
    weather_entity: weather.kmdw
    calendar_entity: calendar.jrgibz_gmail_com
    todo_entity: todo.personal
    agent_id: conversation.morning
    max_events: 5
    max_todos: 6
    do_speak: '{{ speak | default(true) }}'
    tts_entity: tts.piper_2
  sequence:
  - variables:
      w_state: '{{ states(weather_entity) }}'
      w_temp: '{{ state_attr(weather_entity, ''temperature'') }}'
      w_humidity: '{{ state_attr(weather_entity, ''humidity'') }}'
      w_forecast_line: "{% set fc = state_attr(weather_entity, 'forecast') or [] %}
        {% if fc and fc[0] %}\n  High {{ fc[0].temperature }}°, Low {{ fc[0].templow
        if fc[0].templow is not none else '—' }}, {{ (fc[0].condition or '') | replace('_','
        ') }}\n{% else %}No forecast available{% endif %}"
  - target:
      entity_id: '{{ calendar_entity }}'
    data:
      start_date_time: '{{ today_at(''00:00:00'').isoformat() }}'
      end_date_time: '{{ (today_at(''00:00:00'') + timedelta(days=1, hours=3)).isoformat()
        }}'
    response_variable: todays_events
    action: calendar.get_events
  - variables:
      events_raw: "{% set d = todays_events %} {% set key = calendar_entity %} {%
        if d is mapping and key in d %}\n  {{ d[key]['events'] if d[key] is mapping
        and 'events' in d[key] else [] }}\n{% else %}\n  {{ d['events'] if d is mapping
        and 'events' in d else [] }}\n{% endif %}"
      events_list: '{{ (events_raw | sort(attribute=''start''))[:max_events] }}'
      events_md: "{% if (events_list | count) == 0 %}\n  (no events)\n{% else %}\n
        \ {% for e in events_list %}\n    {% set start_val = e.get('start') %}\n    {%
        set end_val   = e.get('end') %}\n    {% set st = as_local(as_datetime(start_val))
        if 'T' in start_val else as_local(as_datetime(start_val ~ 'T00:00:00')) %}\n
        \   {% set et = as_local(as_datetime(end_val))   if 'T' in end_val   else
        as_local(as_datetime(end_val   ~ 'T23:59:59')) %}\n    - {{ st.strftime('%-I:%M
        %p') }}–{{ et.strftime('%-I:%M %p') }}: {{ e.summary }}{% if e.location %}
        @ {{ e.location }}{% endif %}{% if not loop.last %}\\n{% endif %}\n  {% endfor
        %}\n{% endif %}"
  - target:
      entity_id: '{{ todo_entity }}'
    data:
      status: needs_action
    response_variable: todos_resp
    action: todo.get_items
  - variables:
      todos_items_full: "{% set d = todos_resp %} {% set key = todo_entity %} {% if
        d is mapping and key in d %}\n  {{ d[key]['items'] if d[key] is mapping and
        'items' in d[key] else [] }}\n{% else %}\n  {{ d['items'] if d is mapping
        and 'items' in d else [] }}\n{% endif %}"
      todos_sorted: '{% set arr = todos_items_full | list %}

        {{ arr | sort(attribute=''summary'') | sort(attribute=''due'', reverse=false)
        | list }}'
      todos_items: '{{ todos_sorted[:max_todos] }}'
      todos_md: "{% if (todos_items | count) == 0 %}\n  (no to-dos captured)\n{% else
        %}\n  {% for t in todos_items %}\n    - {{ t.summary }}{% if t.due %} (due
        {{ as_local(as_datetime(t.due)).strftime('%-m/%-d') }}){% endif %}{% if not
        loop.last %}\\n{% endif %}\n  {% endfor %}\n{% endif %}"
  - variables:
      llm_prompt: 'You are a strict but motivating morning coach. Write a concise
        spoken briefing (~250 words) for James in Chicago. Tone: confident, playful,
        a little bossy. No questions. Include: (1) weather + clothing/packing tip,
        (2) top events with timing and quick prep/commute notes, (3) from the to-dos
        below, pick 2–3 specific tasks by name and turn them into priorities, (4)
        short focus mantra. End with one actionable step.

        Weather now: {{ (w_state or '''') | replace(''_'','' '') }}, {{ w_temp }}°F,
        humidity {{ w_humidity }}%. Forecast: {{ w_forecast_line }}

        Events today: {{ events_md }}

        To-dos: {{ todos_md }}

        Output plain text for TTS (no bullets or markdown).'
  - continue_on_error: true
    data:
      agent_id: '{{ agent_id }}'
      text: '{{ llm_prompt }}'
    response_variable: convo
    action: conversation.process
  - variables:
      llm_text_raw: "{% set r = convo if convo is defined else none %} {% if r and
        r.response and r.response.speech and r.response.speech.plain and r.response.speech.plain.speech
        %}\n  {{ r.response.speech.plain.speech }}\n{% elif r and r.response and r.response.response_text
        %}\n  {{ r.response.response_text }}\n{% else %}\n  Morning briefing fallback.\n
        \ Weather {{ w_state }}, {{ w_temp }} degrees.\n  Events: {{ events_list |
        count }}. To-dos: {{ todos_items | count }}.\n{% endif %}"
      llm_text: '{{ (llm_text_raw | string).strip() if llm_text_raw is defined else
        ''Morning briefing fallback.'' }}'
  - action: input_text.set_value
    target:
      entity_id: input_text.morning_briefing
    data:
      value: '{{ llm_text }}'
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ do_speak }}'
      sequence:
      - action: media_player.volume_set
        target:
          entity_id: '{{ media_player }}'
        data:
          volume_level: 0.35
      - action: tts.speak
        data:
          entity_id: '{{ tts_entity }}'
          media_player_entity_id: '{{ media_player }}'
          message: '{{ llm_text }}'
          cache: false
    - conditions:
      - condition: template
        value_template: '{{ not do_speak }}'
      sequence:
      - action: persistent_notification.create
        data:
          title: Morning Briefing (dry run)
          message: '{{ llm_text }}'
movie_mode_dim_couch_off_fronts:
  sequence:
  - data:
      zone: kitchen
    action: script.govee_zone_off
  - data:
      zone: dining
    action: script.govee_zone_off
  - data:
      zone: entry_dj
    action: script.govee_zone_off
  - data:
      zone: living_front
    action: script.govee_zone_off
  - data:
      zone: couch_living
      pct: 20
      r: 255
      g: 160
      b: 120
    action: script.govee_zone_on
  - data:
      zone: couch_dj
      pct: 15
      r: 255
      g: 160
      b: 120
    action: script.govee_zone_on
  alias: Movie mode (dim couch, off fronts)
  description: ''
govee_all_lights_25:
  sequence:
  - action: rest_command.govee_dj_brightness_25
  - action: rest_command.govee_dining_strip_brightness_25
    data: {}
  - action: rest_command.govee_living_brightness_25
  alias: Govee — All lights 25%
  mode: parallel
  description: ''
govee_all_lights_50:
  sequence:
  - action: rest_command.govee_dj_brightness_50
  - action: rest_command.govee_dining_strip_brightness_50
    data: {}
  - action: rest_command.govee_living_brightness_50
  alias: Govee — All lights 50%
  mode: parallel
  description: ''
govee_all_lights_75:
  sequence:
  - action: rest_command.govee_dj_brightness_75
  - action: rest_command.govee_dining_strip_brightness_75
    data: {}
  - action: rest_command.govee_living_brightness_75
  alias: Govee — All lights 75%
  mode: parallel
  description: ''
govee_all_lights_100:
  sequence:
  - action: rest_command.govee_dj_brightness_100
  - action: rest_command.govee_dining_strip_brightness_100
    data: {}
  - action: rest_command.govee_living_brightness_100
  alias: Govee — All lights 100%
  mode: parallel
  description: ''
govee_all_lights_off:
  sequence:
  - action: rest_command.govee_dj_brightness_0
  - action: rest_command.govee_dining_strip_brightness_0
    data: {}
  - action: rest_command.govee_living_brightness_0
  alias: Govee — All lights OFF
  mode: parallel
  description: ''
govee_all_lights_white_neutral:
  sequence:
  - action: rest_command.govee_dj_white_neutral
  - action: rest_command.govee_dining_strip_white_neutral
    data: {}
  - action: rest_command.govee_living_white_neutral
  alias: Govee — All lights WHITE (neutral)
  mode: parallel
  description: ''
govee_all_lights_white_warm:
  sequence:
  - action: rest_command.govee_dj_white_warm
  - action: rest_command.govee_dining_strip_white_warm
    data: {}
  - action: rest_command.govee_living_white_warm
  alias: Govee — All lights WHITE (warm)
  mode: parallel
  description: ''
govee_all_lights_white_cool:
  sequence:
  - action: rest_command.govee_dj_white_cool
  - action: rest_command.govee_dining_strip_white_cool
  - action: rest_command.govee_living_white_cool
  alias: Govee — All lights WHITE (cool)
  mode: parallel
  description: ''
play_bossa_nova_living_room_playlist_shuffle:
  alias: Play Bossa Nova Living Room Playlist (Shuffle)
  sequence:
  - target:
      entity_id: media_player.living_room
    data:
      shuffle: true
    action: media_player.shuffle_set
  - target:
      entity_id: media_player.living_room
    data:
      media_content_id: spotify:playlist:4Dot9vPPk2J2rF4z7y5GyI
      media_content_type: music
    action: media_player.play_media
  mode: single
play_home_playlist_living_room_playlist_shuffle:
  alias: Play Home Playlist Living Room Playlist (Shuffle)
  sequence:
  - target:
      entity_id: media_player.living_room
    data:
      shuffle: true
    action: media_player.shuffle_set
  - target:
      entity_id: media_player.living_room
    data:
      media_content_id: spotify:playlist:26y9840X5o1rAiO8CRhoPD
      media_content_type: music
    action: media_player.play_media
  mode: single
  description: ''
govee_party:
  sequence:
  - action: rest_command.govee_living_party
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_party
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_party
    metadata: {}
    data: {}
  alias: Govee - Party
  description: ''
govee_dance_party:
  sequence:
  - action: rest_command.govee_living_dance_party
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_dance_party
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_dance_party
    metadata: {}
    data: {}
  alias: Govee - Dance Party
  description: ''
govee_maillard:
  sequence:
  - action: rest_command.govee_living_maillard
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_maillard
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_maillard
    metadata: {}
    data: {}
  alias: Govee - Maillard
  description: ''
govee_passion:
  sequence:
  - action: rest_command.govee_living_passion
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_passion
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_passion
    metadata: {}
    data: {}
  alias: Govee - Passion
  description: ''
govee_radiance:
  sequence:
  - action: rest_command.govee_living_radiance
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_radiance
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_radiance
    metadata: {}
    data: {}
  alias: Govee - Radiance
  description: ''
govee_rococo:
  sequence:
  - action: rest_command.govee_living_rococo
    metadata: {}
    data: {}
  - action: rest_command.govee_dining_strip_rococo
    metadata: {}
    data: {}
  - action: rest_command.govee_dj_rococo
    metadata: {}
    data: {}
  alias: Govee - Rococo
  description: ''
morning_lights:
  sequence:
  - action: script.govee_all_lights_white_cool
    metadata: {}
    data: {}
  - action: script.govee_all_lights_100
    metadata: {}
    data: {}
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.morning
  alias: Morning Lights
  description: ''
daytime_lights:
  sequence:
  - action: script.govee_all_lights_75
    metadata: {}
    data: {}
  - action: script.govee_all_lights_white_neutral
    metadata: {}
    data: {}
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.daytime_2
  alias: Daytime Lights
  description: ''
evening_lights:
  sequence:
  - action: script.govee_all_lights_75
    metadata: {}
    data: {}
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.evening
  - action: script.govee_all_lights_white_warm
    metadata: {}
    data: {}
  alias: Evening Lights
  description: ''
chill_lights:
  sequence:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.night_chill
  - action: script.govee_maillard
    metadata: {}
    data: {}
  alias: Chill Lights
  description: ''
lighting_route_by_time_now:
  alias: Lighting - Route By Time (Now)
  mode: restart
  variables:
    morning_script: script.morning_lights
    day_script: script.daytime_lights
    evening_script: script.evening_lights
    chill_script: script.chill_lights
    morning_start: 05:00:00
    day_start: 08:00:00
    night_start: '22:00:00'
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ now() >= today_at(morning_start) and\n   now() <  today_at(day_start)
          }}\n"
      sequence:
      - target:
          entity_id: '{{ morning_script }}'
        action: script.turn_on
    - conditions:
      - condition: template
        value_template: "{{ now() >= today_at(day_start) and\n   is_state('sun.sun','above_horizon')
          }}\n"
      sequence:
      - target:
          entity_id: '{{ day_script }}'
        action: script.turn_on
    - conditions:
      - condition: template
        value_template: "{{ is_state('sun.sun','below_horizon') and\n   now() < today_at(night_start)
          }}\n"
      sequence:
      - target:
          entity_id: '{{ evening_script }}'
        action: script.turn_on
    default:
    - target:
        entity_id: '{{ chill_script }}'
      action: script.turn_on
  description: ''
lights_off:
  sequence:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.away
  - action: script.govee_all_lights_off
    metadata: {}
    data: {}
  alias: Lights Off
  description: ''
tv_open_kiosk_browser:
  alias: TV - Open Kiosk Browser
  mode: restart
  description: Power on the Google TV and launch Fully Kiosk Browser.
  variables:
    tv_entity: media_player.living_room_tv_2
    kiosk_package: de.ozerov.fully
    kiosk_url: http://jamess-mac-mini.local:3000/tv/
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ states(tv_entity) == ''off'' }}'
      sequence:
      - action: media_player.turn_on
        target:
          entity_id: '{{ tv_entity }}'
      - wait_template: '{{ is_state(tv_entity, ''on'') }}'
        timeout: 00:00:25
        continue_on_timeout: true
  - delay: 00:00:02
  - action: media_player.play_media
    target:
      entity_id: '{{ tv_entity }}'
    data:
      media_content_type: app
      media_content_id: '{{ kiosk_package }}'
  - delay: 00:00:02
kiosk_launch:
  sequence:
  - type: turn_on
    device_id: 7d5fcd316152f4fca9a268615d7329a9
    entity_id: 0589d63ff48533409f7079333291644c
    domain: remote
  - action: media_player.play_media
    metadata: {}
    data:
      media:
        media_content_id: de.ozerov.fully
        media_content_type: app
        metadata:
          title: Fully Kiosk Browser
          thumbnail: https://play-lh.googleusercontent.com/WoXt70HB47lypeBgA0KfVTCSz8ekMbHfM53HXT6CAbOyJQeH-nDAReeJ8C4-EhazTA=s96-rw
          media_class: app
          children_media_class:
          navigateIds:
          - {}
          browse_entity_id: media_player.living_room_tv_2
    target:
      entity_id: media_player.living_room_tv_2
  alias: kiosk launch
  description: ''
toggle_lights:
  sequence:
  - if:
    - condition: state
      entity_id: light.office
      state: 'on'
    then:
    - action: script.lights_off
      metadata: {}
      data: {}
    else:
    - action: script.lighting_route_by_time_now
      metadata: {}
      data: {}
  alias: Toggle Lights
  description: ''
toggle_shades:
  sequence:
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: binary_sensor.closetshade_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.diningshade_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.djshade_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.tvshade_opening
        state: 'on'
    then:
    - action: script.close_shades
      metadata: {}
      data: {}
    else:
    - action: script.open_shades
      metadata: {}
      data: {}
  alias: toggle shades
  description: ''
toggle_blinds:
  sequence:
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: binary_sensor.bedblind_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.closetblind_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.diningblind_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.djblind_opening
        state: 'on'
      - condition: state
        entity_id: binary_sensor.tvblind_opening
        state: 'on'
    then:
    - action: script.close_blinds
      metadata: {}
      data: {}
    else:
    - action: script.open_blinds
      metadata: {}
      data: {}
  alias: toggle blinds
  description: ''
